@include(top.htm)

@include(savedPopup.htm)

<div id="snapshotPopup" class="popup">
	<video id="snapshotVideo"></video>

	<div class="buttonbar">
		<div onclick="takeSnapshot();">Take Snapshot</div>
	</div>

	<canvas id="snapshotCanvas" style="display: none;"></canvas>

	<div id="snapshotButtons" class="buttonbar" style="display: none; margin-bottom: 1.5em;">
		<div onclick="snapshotOk();" class="oneoftwo">OK</div>
		<div onclick="snapshotCancel();" class="oneoftwo">Cancel</div>
	</div>
</div>

<div id="headline">Nowhere Lost and Found Logbook</div>

<div>Glad to hear that you have found something!</div>

<div>Please tell me about what you have found.</div>

<div>What have you found?</div>

<textarea id="found-what" placeholder="E.g.:&#10;• A golden chain with some green stone attached to it; there is a picture of a duck or something with blueish eyes on the stone&#10;• A white phone (Android) with a Burning Man 2023 sticker"></textarea>

<div>Please take a picture of it:</div>

<canvas id="found-picture" style="display: none;"></canvas>

<div class="buttonbar">
	<div onclick="openSnapshotPopup();">Take Photo with the Webcam of the Laptop</div>
</div>

<div>When have you found it?</div>

<textarea id="found-when" placeholder="E.g.:&#10;• Yesterday at 23:52&#10;• Just after the big fire drill that happened before the official start of Nowhere"></textarea>

<div>Where have you found it?</div>

<textarea id="found-where" placeholder="E.g.:&#10;• Just in front of the Gate&#10;• Halfway between MoN and the Red Cross"></textarea>

<div>What is your name?<br>
(Just in case the person whose item you found wants to know who to thank. ^^)</div>

<textarea id="found-who" placeholder="E.g.:&#10;• Jon Snow, Prince of Dragonstone&#10;• Hermione Jean Granger"></textarea>

<div class="buttonbar" style="margin-bottom: 6em;">
	<div onclick="saveFoundItem();">Save this Found Item</div>
</div>


<script>

	function openSnapshotPopup() {

		document.getElementById("snapshotPopup").style.display = "block";
		document.getElementById("overlay").style.display = "block";

		var wantedPermission = {"video": true};
		var onError = function(error) {
			console.log(error);
		};

		if (navigator.getUserMedia) {
			navigator.getUserMedia(wantedPermission, onWebcamStartup, onError);
		} else if (navigator.mozGetUserMedia) {
			navigator.mozGetUserMedia(wantedPermission, onWebcamStartup, onError);
		} else if (navigator.webkitGetUserMedia) {
			navigator.webkitGetUserMedia(wantedPermission, onWebcamStartup, onError);
		};
	}

	function onWebcamStartup(stream) {

		var video = document.getElementById("snapshotVideo");

		video.srcObject = stream;

		video.play();
	}

	function snapshotOk() {

		var originCanvas = document.getElementById("snapshotCanvas");
		var targetCanvas = document.getElementById("found-picture");

		targetCanvas.width = originCanvas.width;
		targetCanvas.height = originCanvas.height;

		var ctx = targetCanvas.getContext("2d");

		ctx.drawImage(
			originCanvas,
			0, 0,
			originCanvas.width, originCanvas.height
		);

		targetCanvas.style.display = "block";

		snapshotCancel();
	}

	function snapshotCancel() {

		var video = document.getElementById("snapshotVideo");

		video.pause();

		document.getElementById("snapshotPopup").style.display = "none";
		document.getElementById("overlay").style.display = "none";
	}

	function takeSnapshot() {

		var video = document.getElementById("snapshotVideo");
		var canvas = document.getElementById("snapshotCanvas");

		canvas.width = video.offsetWidth;
		canvas.height = video.offsetHeight;

		var ctx = canvas.getContext("2d");

		ctx.drawImage(
			video,
			0, 0,
			video.offsetWidth, video.offsetHeight
		);

		canvas.style.display = "inline";
		document.getElementById("snapshotButtons").style.display = "block";
	}

	function saveFoundItem() {

		var request = new XMLHttpRequest();
		request.open("POST", "/saveFoundItem", false);
		request.setRequestHeader("Content-Type", "application/json");

		request.onreadystatechange = function() {
			if (request.readyState == 4 && request.status == 200) {
				// TODO :: check that actually success: true is sent from the server!
				showSaved();
			}
		}

		var data = {
			what: document.getElementById("found-what").value,
			when: document.getElementById("found-when").value,
			where: document.getElementById("found-where").value,
			who: document.getElementById("found-who").value,
		};

		foundPicture = document.getElementById("found-picture");

		if (foundPicture.style.display == "block") {
			// send as normal quality JPEG...
			data.picture = foundPicture.toDataURL("image/jpeg", 0.8);
		}

		request.send(JSON.stringify(data));
	}

</script>

@include(bottom.htm)
